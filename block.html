<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方块爆破游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            padding: 20px;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 900px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 2px solid #3a86ff;
        }
        
        h1 {
            color: #3a86ff;
            margin-bottom: 10px;
            text-align: center;
            font-size: 2.8rem;
            text-shadow: 0 0 15px rgba(58, 134, 255, 0.7);
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #ff9e00;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid rgba(58, 134, 255, 0.3);
        }
        
        .stats-container {
            display: flex;
            gap: 30px;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-title {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
        }
        
        #score {
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }
        
        #lives {
            color: #ff9e00;
            text-shadow: 0 0 10px rgba(255, 158, 0, 0.7);
        }
        
        #level {
            color: #72efdd;
            text-shadow: 0 0 10px rgba(114, 239, 221, 0.7);
        }
        
        .game-area {
            position: relative;
            margin-bottom: 25px;
        }
        
        #game-canvas {
            border: 3px solid #3a86ff;
            border-radius: 10px;
            background-color: #0a0e27;
            display: block;
            box-shadow: 0 0 30px rgba(58, 134, 255, 0.2);
        }
        
        .game-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            width: 100%;
        }
        
        button {
            background: linear-gradient(to right, #3a86ff, #4361ee);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 160px;
            box-shadow: 0 6px 0 #2a5fcc;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        button:hover {
            background: linear-gradient(to right, #4361ee, #3a86ff);
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #2a5fcc;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 4px 0 #2a5fcc;
        }
        
        button#pause-btn {
            background: linear-gradient(to right, #ff9e00, #ff9100);
            box-shadow: 0 6px 0 #cc7400;
        }
        
        button#pause-btn:hover {
            background: linear-gradient(to right, #ff9100, #ff9e00);
            box-shadow: 0 9px 0 #cc7400;
        }
        
        button#pause-btn:active {
            box-shadow: 0 4px 0 #cc7400;
        }
        
        button#restart-btn {
            background: linear-gradient(to right, #f72585, #b5179e);
            box-shadow: 0 6px 0 #8a126e;
        }
        
        button#restart-btn:hover {
            background: linear-gradient(to right, #b5179e, #f72585);
            box-shadow: 0 9px 0 #8a126e;
        }
        
        button#restart-btn:active {
            box-shadow: 0 4px 0 #8a126e;
        }
        
        .game-info {
            display: flex;
            flex-direction: column;
            gap: 25px;
            width: 100%;
        }
        
        .info-section {
            background-color: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #3a86ff;
        }
        
        h2 {
            color: #4cc9f0;
            margin-bottom: 15px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2::before {
            content: "▶";
            color: #ff9e00;
            font-size: 1.2rem;
        }
        
        p {
            line-height: 1.7;
            margin-bottom: 10px;
            color: #ddd;
            font-size: 1.1rem;
        }
        
        .instructions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .instruction-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: rgba(58, 134, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(58, 134, 255, 0.3);
        }
        
        .key {
            background-color: #222;
            color: #4cc9f0;
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #3a86ff;
            min-width: 60px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .powerup-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .powerup {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .powerup-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            z-index: 10;
            display: none;
        }
        
        .game-over h2 {
            color: #f72585;
            font-size: 4rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(247, 37, 133, 0.7);
        }
        
        .game-over p {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #fff;
        }
        
        .level-complete {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 14, 39, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            z-index: 10;
            display: none;
        }
        
        .level-complete h2 {
            color: #72efdd;
            font-size: 4rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(114, 239, 221, 0.7);
        }
        
        .level-complete p {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: #fff;
        }
        
        .powerup-active {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(58, 134, 255, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 5;
            display: none;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }
        
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .stats-container {
                width: 100%;
                justify-content: space-around;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
            }
            
            #game-canvas {
                width: 100%;
                height: auto;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .instructions {
                grid-template-columns: 1fr;
            }
            
            .powerup-info {
                flex-direction: column;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>方块爆破</h1>
        <div class="subtitle">使用挡板反弹球消除所有方块，小心不要丢失球！</div>
        
        <div class="game-header">
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-title">分数</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">生命</div>
                    <div class="stat-value" id="lives">3</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">关卡</div>
                    <div class="stat-value" id="level">1</div>
                </div>
            </div>
        </div>
        
        <div class="game-area">
            <canvas id="game-canvas" width="800" height="500"></canvas>
            
            <div class="powerup-active" id="powerup-active"></div>
            
            <div class="game-over" id="game-over">
                <h2>游戏结束!</h2>
                <p>最终得分: <span id="final-score">0</span></p>
                <button id="play-again-btn">再玩一次</button>
            </div>
            
            <div class="level-complete" id="level-complete">
                <h2>关卡完成!</h2>
                <p>进入下一关</p>
                <button id="next-level-btn">下一关</button>
            </div>
        </div>
        
        <div class="game-controls">
            <button id="start-btn">开始游戏</button>
            <button id="pause-btn">暂停游戏</button>
            <button id="restart-btn">重新开始</button>
        </div>
        
        <div class="game-info">
            <div class="info-section">
                <h2>游戏说明</h2>
                <p>使用鼠标或键盘左右移动挡板，反弹球来消除所有彩色方块。</p>
                <p>每个方块被击中时会消失并增加你的分数。如果球掉落到屏幕底部，你将失去一条生命。</p>
                <p>收集特殊方块可以获得能量提升！</p>
                
                <div class="instructions">
                    <div class="instruction-item">
                        <div class="key">←</div>
                        <div>向左移动挡板</div>
                    </div>
                    <div class="instruction-item">
                        <div class="key">→</div>
                        <div>向右移动挡板</div>
                    </div>
                    <div class="instruction-item">
                        <div class="key">鼠标</div>
                        <div>移动鼠标控制挡板</div>
                    </div>
                    <div class="instruction-item">
                        <div class="key">空格</div>
                        <div>暂停/继续游戏</div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h2>能量提升</h2>
                <p>特殊方块被击中时会掉落能量提升，收集它们可以获得特殊能力：</p>
                
                <div class="powerup-info">
                    <div class="powerup">
                        <div class="powerup-color" style="background-color: #4cc9f0;"></div>
                        <div>扩大挡板尺寸</div>
                    </div>
                    <div class="powerup">
                        <div class="powerup-color" style="background-color: #ff9e00;"></div>
                        <div>增加球的速度</div>
                    </div>
                    <div class="powerup">
                        <div class="powerup-color" style="background-color: #72efdd;"></div>
                        <div>额外生命</div>
                    </div>
                    <div class="powerup">
                        <div class="powerup-color" style="background-color: #f72585;"></div>
                        <div>穿透方块</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏变量
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const levelElement = document.getElementById('level');
        const finalScoreElement = document.getElementById('final-score');
        const gameOverScreen = document.getElementById('game-over');
        const levelCompleteScreen = document.getElementById('level-complete');
        const powerupActiveElement = document.getElementById('powerup-active');
        
        // 按钮元素
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const restartBtn = document.getElementById('restart-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        
        // 游戏设置
        const paddleHeight = 15;
        const paddleMinWidth = 100;
        const paddleMaxWidth = 200;
        const ballSize = 12;
        const brickRows = 8;
        const brickCols = 10;
        const brickPadding = 5;
        const brickOffsetTop = 60;
        const brickOffsetLeft = 35;
        
        // 游戏状态
        let paddleWidth = 120;
        let paddleX = (canvas.width - paddleWidth) / 2;
        let ballX = canvas.width / 2;
        let ballY = canvas.height - 50;
        let ballSpeedX = 5;
        let ballSpeedY = -5;
        let ballSpeed = 5;
        let score = 0;
        let lives = 3;
        let level = 1;
        let gameRunning = false;
        let gamePaused = false;
        let rightPressed = false;
        let leftPressed = false;
        let animationId;
        
        // 方块数组
        let bricks = [];
        // 能量提升数组
        let powerups = [];
        
        // 能量提升类型
        const POWERUP_TYPES = {
            EXTEND_PADDLE: { color: '#4cc9f0', name: '挡板扩大', duration: 10000 },
            SPEED_BALL: { color: '#ff9e00', name: '球加速', duration: 8000 },
            EXTRA_LIFE: { color: '#72efdd', name: '额外生命', duration: 0 },
            PIERCE_BALL: { color: '#f72585', name: '穿透球', duration: 5000 }
        };
        
        // 当前激活的能量提升
        let activePowerup = null;
        let powerupTimer = 0;
        
        // 初始化游戏
        function initGame() {
            // 初始化挡板和球
            paddleWidth = 120;
            paddleX = (canvas.width - paddleWidth) / 2;
            ballX = canvas.width / 2;
            ballY = canvas.height - 50;
            ballSpeed = 5 + (level - 1) * 0.5;
            ballSpeedX = ballSpeed;
            ballSpeedY = -ballSpeed;
            
            // 初始化方块
            initBricks();
            
            // 清空能量提升
            powerups = [];
            
            // 重置能量提升状态
            activePowerup = null;
            powerupTimer = 0;
            powerupActiveElement.style.display = 'none';
            
            // 更新显示
            updateDisplay();
            
            // 绘制初始游戏状态
            draw();
        }
        
        // 初始化方块
        function initBricks() {
            bricks = [];
            
            // 不同关卡有不同的方块布局
            let brickColors;
            if (level === 1) {
                brickColors = ['#3a86ff', '#4361ee', '#4cc9f0', '#4895ef', '#7209b7'];
            } else if (level === 2) {
                brickColors = ['#ff9e00', '#ff9100', '#ff8500', '#ff6d00', '#ff5400'];
            } else {
                brickColors = ['#f72585', '#b5179e', '#7209b7', '#560bad', '#480ca8'];
            }
            
            // 计算方块尺寸
            const brickWidth = (canvas.width - 2 * brickOffsetLeft - (brickCols - 1) * brickPadding) / brickCols;
            const brickHeight = 22;
            
            // 创建方块
            for (let c = 0; c < brickCols; c++) {
                bricks[c] = [];
                for (let r = 0; r < brickRows; r++) {
                    // 随机决定是否为特殊方块（掉落能量提升）
                    const isPowerupBrick = Math.random() < 0.15 && r < brickRows - 2;
                    
                    bricks[c][r] = {
                        x: c * (brickWidth + brickPadding) + brickOffsetLeft,
                        y: r * (brickHeight + brickPadding) + brickOffsetTop,
                        width: brickWidth,
                        height: brickHeight,
                        color: brickColors[r % brickColors.length],
                        status: 1, // 1表示存在，0表示被摧毁
                        isPowerupBrick: isPowerupBrick
                    };
                }
            }
        }
        
        // 绘制游戏
        function draw() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            drawBackground();
            
            // 绘制方块
            drawBricks();
            
            // 绘制挡板
            drawPaddle();
            
            // 绘制球
            drawBall();
            
            // 绘制能量提升
            drawPowerups();
            
            // 绘制能量提升激活提示
            if (activePowerup) {
                const timeLeft = Math.ceil((powerupTimer - Date.now()) / 1000);
                if (timeLeft > 0) {
                    powerupActiveElement.textContent = `${activePowerup.name} - ${timeLeft}秒`;
                }
            }
        }
        
        // 绘制背景
        function drawBackground() {
            // 渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a0e27');
            gradient.addColorStop(1, '#1a1f4e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制网格
            ctx.strokeStyle = 'rgba(58, 134, 255, 0.1)';
            ctx.lineWidth = 1;
            
            // 垂直线
            for (let x = 0; x <= canvas.width; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // 水平线
            for (let y = 0; y <= canvas.height; y += 40) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        // 绘制方块
        function drawBricks() {
            for (let c = 0; c < brickCols; c++) {
                for (let r = 0; r < brickRows; r++) {
                    const brick = bricks[c][r];
                    if (brick.status === 1) {
                        // 绘制方块
                        ctx.fillStyle = brick.color;
                        ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
                        
                        // 方块边框
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(brick.x, brick.y, brick.width, brick.height);
                        
                        // 如果是特殊方块，绘制特殊标记
                        if (brick.isPowerupBrick) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.beginPath();
                            ctx.arc(
                                brick.x + brick.width / 2,
                                brick.y + brick.height / 2,
                                brick.height / 4,
                                0,
                                Math.PI * 2
                            );
                            ctx.fill();
                        }
                    }
                }
            }
        }
        
        // 绘制挡板
        function drawPaddle() {
            // 挡板渐变
            const gradient = ctx.createLinearGradient(paddleX, canvas.height - paddleHeight, paddleX, canvas.height);
            gradient.addColorStop(0, '#3a86ff');
            gradient.addColorStop(1, '#4361ee');
            ctx.fillStyle = gradient;
            
            // 绘制挡板
            ctx.beginPath();
            ctx.roundRect(paddleX, canvas.height - paddleHeight, paddleWidth, paddleHeight, 10);
            ctx.fill();
            
            // 挡板边框
            ctx.strokeStyle = '#4cc9f0';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 挡板内部装饰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.fillRect(paddleX + 10, canvas.height - paddleHeight + 5, paddleWidth - 20, 3);
        }
        
        // 绘制球
        function drawBall() {
            // 根据能量提升状态改变球的颜色
            let ballColor = '#ffffff';
            if (activePowerup && activePowerup.name === POWERUP_TYPES.PIERCE_BALL.name) {
                ballColor = '#f72585';
            } else if (activePowerup && activePowerup.name === POWERUP_TYPES.SPEED_BALL.name) {
                ballColor = '#ff9e00';
            }
            
            // 球体渐变
            const gradient = ctx.createRadialGradient(
                ballX, ballY, 0,
                ballX, ballY, ballSize
            );
            gradient.addColorStop(0, ballColor);
            gradient.addColorStop(1, darkenColor(ballColor, 40));
            
            ctx.fillStyle = gradient;
            
            // 绘制球
            ctx.beginPath();
            ctx.arc(ballX, ballY, ballSize, 0, Math.PI * 2);
            ctx.fill();
            
            // 球体高光
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.arc(ballX - ballSize/3, ballY - ballSize/3, ballSize/3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // 绘制能量提升
        function drawPowerups() {
            for (let i = 0; i < powerups.length; i++) {
                const powerup = powerups[i];
                
                // 绘制能量提升
                ctx.fillStyle = powerup.color;
                ctx.beginPath();
                ctx.arc(powerup.x, powerup.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // 能量提升边框
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // 能量提升发光效果
                ctx.shadowColor = powerup.color;
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(powerup.x, powerup.y, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
        
        // 更新游戏状态
        function update() {
            // 移动挡板
            if (rightPressed && paddleX < canvas.width - paddleWidth) {
                paddleX += 7;
            } else if (leftPressed && paddleX > 0) {
                paddleX -= 7;
            }
            
            // 移动球
            ballX += ballSpeedX;
            ballY += ballSpeedY;
            
            // 检测球与墙壁碰撞
            // 左右墙
            if (ballX + ballSpeedX > canvas.width - ballSize || ballX + ballSpeedX < ballSize) {
                ballSpeedX = -ballSpeedX;
            }
            
            // 上墙
            if (ballY + ballSpeedY < ballSize) {
                ballSpeedY = -ballSpeedY;
            }
            
            // 下墙（掉出屏幕）
            else if (ballY + ballSpeedY > canvas.height - ballSize) {
                // 检测球与挡板碰撞
                if (ballX > paddleX && ballX < paddleX + paddleWidth) {
                    // 根据击中挡板的位置改变反弹角度
                    const hitPoint = (ballX - paddleX) / paddleWidth;
                    const angle = hitPoint * Math.PI - Math.PI / 2; // -90° 到 90°
                    
                    // 计算新的速度
                    const speed = Math.sqrt(ballSpeedX * ballSpeedX + ballSpeedY * ballSpeedY);
                    ballSpeedX = speed * Math.cos(angle);
                    ballSpeedY = -speed * Math.sin(angle);
                } else {
                    // 球掉出屏幕，失去一条生命
                    loseLife();
                    return;
                }
            }
            
            // 检测球与方块碰撞
            detectBrickCollision();
            
            // 更新能量提升位置
            updatePowerups();
            
            // 检查能量提升是否过期
            checkPowerupExpiry();
            
            // 检查是否完成关卡
            if (checkLevelComplete()) {
                completeLevel();
                return;
            }
            
            // 重绘画布
            draw();
        }
        
        // 检测球与方块碰撞
        function detectBrickCollision() {
            for (let c = 0; c < brickCols; c++) {
                for (let r = 0; r < brickRows; r++) {
                    const brick = bricks[c][r];
                    if (brick.status === 1) {
                        // 检测碰撞
                        if (
                            ballX > brick.x &&
                            ballX < brick.x + brick.width &&
                            ballY > brick.y &&
                            ballY < brick.y + brick.height
                        ) {
                            // 如果球有穿透能力，不改变方向
                            if (!activePowerup || activePowerup.name !== POWERUP_TYPES.PIERCE_BALL.name) {
                                // 确定从哪边碰撞
                                const prevX = ballX - ballSpeedX;
                                const prevY = ballY - ballSpeedY;
                                
                                // 从左右碰撞
                                if (prevX <= brick.x || prevX >= brick.x + brick.width) {
                                    ballSpeedX = -ballSpeedX;
                                }
                                // 从上下碰撞
                                else {
                                    ballSpeedY = -ballSpeedY;
                                }
                            }
                            
                            // 摧毁方块
                            brick.status = 0;
                            
                            // 增加分数
                            score += 10 * level;
                            updateDisplay();
                            
                            // 如果是特殊方块，生成能量提升
                            if (brick.isPowerupBrick) {
                                createPowerup(brick.x + brick.width / 2, brick.y + brick.height / 2);
                            }
                            
                            // 如果没有穿透能力，跳出循环
                            if (!activePowerup || activePowerup.name !== POWERUP_TYPES.PIERCE_BALL.name) {
                                return;
                            }
                        }
                    }
                }
            }
        }
        
        // 创建能量提升
        function createPowerup(x, y) {
            // 随机选择能量提升类型
            const powerupTypes = Object.values(POWERUP_TYPES);
            const randomType = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
            
            powerups.push({
                x: x,
                y: y,
                type: randomType,
                color: randomType.color,
                speed: 2
            });
        }
        
        // 更新能量提升位置
        function updatePowerups() {
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                
                // 向下移动能量提升
                powerup.y += powerup.speed;
                
                // 检测能量提升与挡板碰撞
                if (
                    powerup.y > canvas.height - paddleHeight &&
                    powerup.y < canvas.height &&
                    powerup.x > paddleX &&
                    powerup.x < paddleX + paddleWidth
                ) {
                    // 激活能量提升
                    activatePowerup(powerup.type);
                    
                    // 从数组中移除
                    powerups.splice(i, 1);
                }
                // 如果能量提升掉出屏幕，移除它
                else if (powerup.y > canvas.height) {
                    powerups.splice(i, 1);
                }
            }
        }
        
        // 激活能量提升
        function activatePowerup(powerupType) {
            activePowerup = powerupType;
            
            // 显示激活提示
            powerupActiveElement.textContent = `${powerupType.name} 已激活!`;
            powerupActiveElement.style.display = 'block';
            powerupActiveElement.style.backgroundColor = powerupType.color;
            
            // 设置能量提升计时器
            if (powerupType.duration > 0) {
                powerupTimer = Date.now() + powerupType.duration;
            }
            
            // 应用能量提升效果
            switch(powerupType.name) {
                case POWERUP_TYPES.EXTEND_PADDLE.name:
                    paddleWidth = Math.min(paddleWidth + 40, paddleMaxWidth);
                    break;
                case POWERUP_TYPES.SPEED_BALL.name:
                    ballSpeedX *= 1.5;
                    ballSpeedY *= 1.5;
                    break;
                case POWERUP_TYPES.EXTRA_LIFE.name:
                    lives++;
                    updateDisplay();
                    break;
                case POWERUP_TYPES.PIERCE_BALL.name:
                    // 穿透效果已在碰撞检测中处理
                    break;
            }
            
            // 3秒后隐藏提示
            setTimeout(() => {
                powerupActiveElement.style.display = 'none';
            }, 3000);
        }
        
        // 检查能量提升是否过期
        function checkPowerupExpiry() {
            if (activePowerup && activePowerup.duration > 0 && Date.now() > powerupTimer) {
                // 移除能量提升效果
                switch(activePowerup.name) {
                    case POWERUP_TYPES.EXTEND_PADDLE.name:
                        paddleWidth = Math.max(paddleWidth - 40, paddleMinWidth);
                        break;
                    case POWERUP_TYPES.SPEED_BALL.name:
                        ballSpeedX /= 1.5;
                        ballSpeedY /= 1.5;
                        break;
                    case POWERUP_TYPES.PIERCE_BALL.name:
                        // 无需恢复，只是停止穿透效果
                        break;
                }
                
                // 清除当前能量提升
                activePowerup = null;
                powerupActiveElement.style.display = 'none';
            }
        }
        
        // 检查是否完成关卡
        function checkLevelComplete() {
            for (let c = 0; c < brickCols; c++) {
                for (let r = 0; r < brickRows; r++) {
                    if (bricks[c][r].status === 1) {
                        return false;
                    }
                }
            }
            return true;
        }
        
        // 完成关卡
        function completeLevel() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            
            // 显示关卡完成画面
            levelCompleteScreen.style.display = 'flex';
        }
        
        // 进入下一关
        function nextLevel() {
            level++;
            levelElement.textContent = level;
            
            // 隐藏关卡完成画面
            levelCompleteScreen.style.display = 'none';
            
            // 初始化新关卡
            initGame();
            
            // 开始游戏
            startGame();
        }
        
        // 失去生命
        function loseLife() {
            lives--;
            updateDisplay();
            
            if (lives <= 0) {
                gameOver();
            } else {
                // 重置球和挡板位置
                ballX = canvas.width / 2;
                ballY = canvas.height - 50;
                ballSpeedX = ballSpeed;
                ballSpeedY = -ballSpeed;
                paddleX = (canvas.width - paddleWidth) / 2;
                
                // 绘制一次
                draw();
            }
        }
        
        // 游戏结束
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            
            // 显示最终分数
            finalScoreElement.textContent = score;
            
            // 显示游戏结束画面
            gameOverScreen.style.display = 'flex';
        }
        
        // 开始游戏
        function startGame() {
            if (!gameRunning) {
                gameRunning = true;
                gamePaused = false;
                pauseBtn.textContent = "暂停游戏";
                
                // 开始游戏循环
                gameLoop();
            }
        }
        
        // 游戏循环
        function gameLoop() {
            update();
            if (gameRunning && !gamePaused) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }
        
        // 暂停/继续游戏
        function togglePause() {
            if (!gameRunning) return;
            
            if (gamePaused) {
                // 继续游戏
                gamePaused = false;
                pauseBtn.textContent = "暂停游戏";
                gameLoop();
            } else {
                // 暂停游戏
                gamePaused = true;
                pauseBtn.textContent = "继续游戏";
                cancelAnimationFrame(animationId);
                
                // 绘制暂停文本
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#ff9e00';
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('游戏暂停', canvas.width / 2, canvas.height / 2);
                
                ctx.fillStyle = 'white';
                ctx.font = '30px Arial';
                ctx.fillText('按空格键或点击按钮继续', canvas.width / 2, canvas.height / 2 + 60);
            }
        }
        
        // 重新开始游戏
        function restartGame() {
            // 重置游戏状态
            score = 0;
            lives = 3;
            level = 1;
            
            // 更新显示
            updateDisplay();
            
            // 初始化游戏
            initGame();
            
            // 隐藏游戏结束画面
            gameOverScreen.style.display = 'none';
            levelCompleteScreen.style.display = 'none';
            
            // 停止当前游戏循环
            if (gameRunning) {
                cancelAnimationFrame(animationId);
            }
            
            // 开始新游戏
            startGame();
        }
        
        // 更新显示
        function updateDisplay() {
            scoreElement.textContent = score;
            livesElement.textContent = lives;
            levelElement.textContent = level;
        }
        
        // 工具函数：加深颜色
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            
            return "#" + (
                0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }
        
        // 键盘控制
        document.addEventListener('keydown', (event) => {
            // 空格键暂停/继续
            if (event.code === 'Space') {
                event.preventDefault();
                togglePause();
                return;
            }
            
            // 方向键控制挡板
            if (event.key === 'Right' || event.key === 'ArrowRight') {
                rightPressed = true;
            } else if (event.key === 'Left' || event.key === 'ArrowLeft') {
                leftPressed = true;
            }
        });
        
        document.addEventListener('keyup', (event) => {
            if (event.key === 'Right' || event.key === 'ArrowRight') {
                rightPressed = false;
            } else if (event.key === 'Left' || event.key === 'ArrowLeft') {
                leftPressed = false;
            }
        });
        
        // 鼠标控制
        canvas.addEventListener('mousemove', (event) => {
            if (!gameRunning || gamePaused) return;
            
            const relativeX = event.clientX - canvas.getBoundingClientRect().left;
            if (relativeX > 0 && relativeX < canvas.width) {
                paddleX = relativeX - paddleWidth / 2;
                
                // 确保挡板不超出画布
                if (paddleX < 0) {
                    paddleX = 0;
                } else if (paddleX > canvas.width - paddleWidth) {
                    paddleX = canvas.width - paddleWidth;
                }
            }
        });
        
        // 按钮事件监听
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', togglePause);
        restartBtn.addEventListener('click', restartGame);
        playAgainBtn.addEventListener('click', restartGame);
        nextLevelBtn.addEventListener('click', nextLevel);
        
        // 初始化游戏
        initGame();
        updateDisplay();
        
        // 添加圆角矩形方法
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            };
        }
    </script>
</body>
</html>

